# Main site - softdab.tech and www
server {
    server_name softdab.tech www.softdab.tech;
    client_max_body_size 10M;
    root /var/www/html;
    index index.html;

    access_log /var/log/nginx/softdab-access.log;
    error_log /var/log/nginx/softdab-error.log;

    # Admin API
    location /admin/api/ {
        proxy_pass http://127.0.0.1:8001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /admin {
        alias /var/www/softdab/admin/frontend/;
        try_files $uri $uri/ /admin/index.html;
    }

    # Main API
    location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Block sensitive files
    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Blog subdomain - WordPress
server {
    server_name blog.softdab.tech;
    root /var/www/subdomains/blog;
    index index.php index.html;

    access_log /var/log/nginx/blog-access.log;
    error_log /var/log/nginx/blog-error.log;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Cryptography subdomain
server {
    server_name cryptography.softdab.tech;
    root /var/www/subdomains/cryptography;
    index index.html index.php;

    access_log /var/log/nginx/cryptography-access.log;
    error_log /var/log/nginx/cryptography-error.log;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Optical subdomain
server {
    server_name optical.softdab.tech;
    root /var/www/subdomains/optical;
    index index.html;

    access_log /var/log/nginx/optical-access.log;
    error_log /var/log/nginx/optical-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# OpticalDT subdomain
server {
    server_name opticaldt.softdab.tech;
    root /var/www/subdomains/opticaldt;
    index index.html;

    access_log /var/log/nginx/opticaldt-access.log;
    error_log /var/log/nginx/opticaldt-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Opto subdomain
server {
    server_name opto.softdab.tech;
    root /var/www/subdomains/opto;
    index index.html;

    access_log /var/log/nginx/opto-access.log;
    error_log /var/log/nginx/opto-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Optocrypto subdomain
server {
    server_name optocrypto.softdab.tech;
    root /var/www/subdomains/optocrypto;
    index index.html;

    access_log /var/log/nginx/optocrypto-access.log;
    error_log /var/log/nginx/optocrypto-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# SnapSafe subdomain
server {
    server_name snapsafe.softdab.tech;
    root /var/www/subdomains/snapsafe;
    index index.html;

    access_log /var/log/nginx/snapsafe-access.log;
    error_log /var/log/nginx/snapsafe-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# SnapSafe App subdomain
server {
    server_name snapsafeapp.softdab.tech;
    root /var/www/subdomains/snapsafeapp;
    index index.html;

    access_log /var/log/nginx/snapsafeapp-access.log;
    error_log /var/log/nginx/snapsafeapp-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Tyke subdomain
server {
    server_name tyke.softdab.tech;
    root /var/www/subdomains/tyke;
    index index.html;

    access_log /var/log/nginx/tyke-access.log;
    error_log /var/log/nginx/tyke-error.log;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ /\.(env|git|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/softdab.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/softdab.tech/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP to HTTPS redirect for all domains
server {
    listen 80;
    server_name softdab.tech www.softdab.tech blog.softdab.tech cryptography.softdab.tech 
                optical.softdab.tech opto.softdab.tech optocrypto.softdab.tech opticaldt.softdab.tech
                snapsafe.softdab.tech snapsafeapp.softdab.tech tyke.softdab.tech;
    
    return 301 https://$server_name$request_uri;
}
